\chapter{\diva 3D\label{chap:diva3D}}

\diva can be used to perform 3D-analysis for a given variable in an oceanic basin. In this case \diva tools are generally applied to successive horizontal layers at different depths of the basin. The resulting 2D-field analyses are gathered in 3D binary and NetCDF files.

The working directory to perform 3D-analyses is the same as for 2D-analyses: \linebreak \directory{GODIVA\_mm\_yyyy/DIVA3D/divastripped}, where mm and yyyy indicate the month and the year of the considered release.

%\newpage % 

\minitoc

\section{Input subdirectories}
%----------------

As described before, to perform a 2D-analysis, one needs to provide a set of input files in the  \directory{DIVA3D/divastripped/input/} subdirectory. For 3D-analysis, the input files are provided in subdirectories of the input directory and in the input directory.

\subsection[DIVA3D/divastripped/input/divadata subdirectory]{\directory{DIVA3D/divastripped/input/divadata/} subdirectory}

In this directory all (horizontal 2D) data sets to be analysed are provided, and named with regard to the variable name and the depth level number.

\begin{center}
\fbox{
\begin{minipage}{0.9\textwidth}
\vspace{.25cm}
\textbf{Convention:} The files should be named as \file{var.$1xxxx$} where:
\begin{itemize}
\item  \texttt{var} is for variable name.
\item {\bf $xxxx$} is the level number and must be within the range $[0001,9999]$.
\end{itemize}

Levels must be numbered from the bottom (lowest $xxxx$) to the top level (highest $xxxx$).
\vspace{.25cm}
\end{minipage}
}
\end{center}

In this subdirectory, data density files related to data set files are stored:

\begin{center}
\fbox{
\begin{minipage}{0.9\textwidth}
\vspace{.25cm} \file{var.$1xxxx$.DATABINS} and  \file{var.$1xxxx$.DATABINSinfo}.
\vspace{.25cm}
\end{minipage}
}
\end{center}


\btips

 Density files are automatically generated when performing an analysis.

\etips

\subsection[DIVA3D/divastripped/input/divaparam directory]{\directory{DIVA3D/divastripped/input/divaparam/} subdirectory}
%--------------------------------------

In this directory are placed the \file{param.par} and \file{coast.cont} files, as well as all other input files related to \diva parametrisation. The \file{coast.cont} files are named following the corresponding level depth number. \file{param.par} files can be named following the  corresponding variable name and the level depth number or only the level depth number:


\begin{center}
\fbox{
\begin{minipage}{0.9\textwidth}
\vspace{.25cm}
\textbf{Convention:} The files should be named as:
\begin{itemize}
\item  \file{coast.cont.$1xxxx$}
\item  \file{param.par} or \file{param.par.$1xxxx$} or \file{param.par.var.$1xxxx$}
\end{itemize}
{\bf $xxxx$} is the level number and must be within the range $[0001,9999]$.
Levels must be numbered from the bottom (lowest $xxxx$) to the top level (highest $xxxx$).
\vspace{.25cm}
\end{minipage}
}
\end{center}



\subsubsection[input/divaparam content description]{\directory{input/divaparam/} content description}

It may contain the following files:\par

\vspace{0.5cm}
\centerline{
\begin{tabular}{|cc|}
\hline
\file{coast.cont.$1xxxx$}& \file{param.par}\\
 \file{param.par.var.$1xxxx$}& \file{RL.var.$1xxxx$} \\
 \file{RLinfo.dat}& \file{RL.dat} \\
 \file{CLminmax} & \file{SNminmax}\\
 \file{valatxy.coord}& \file{3Dconstraint}\\
\hline
\end{tabular}
}

\begin{description}

\item[\file{coast.cont.$1xxxx$}:] files corresponding to the horizontal levels (as described in \ref{contourdiva}) can be automatically generated by \diva (see Section~\ref{3Dpreproc}).

\item[\file{param.par.var.$1xxxx$}] files corresponding to the considered variable and horizontal levels (as described in \ref{sec:param.par}) with optimised correlation length ($L$), signal-to-noise ratio ($\snr$), and variance of the background ($VARBAK$) parameters can be automatically generated by \diva from a generic \file{param.par} file placed in \directory{DIVA3D/divastripped/input/} (see Section~\ref{3Dpreproc}).

\item[\file{RL.var.$1xxxx$}:] files (and the related info file \file{RLinfo.dat)} can be placed in the \linebreak \directory{input/divaparam/} if one wants to use relative correlation length. They can be also automatically generated by \diva (based of data distribution). It is also possible to place only a unique file named \file{RL.dat} to be used for all the levels.

\item[\file{3Dconstraint}] is a two-column file, where each line corresponds to the level of the same number, and contains the two 
 constraint \index{Advection} parameters to be used (see Section~\ref{sec:advection}) when performing analysis with advection constraint.

The advection constraint files are placed in the \directory{input/divaUVcons} subdirectory. One can provide files named with regard to the variable and the level to which they correspond: \file{Uvel.var.$1xxxx$}, \file{Vvel.var.$1xxxx$}, or only to the level: \file{Uvel.$1xxxx$}, \file{Vvel.$1xxxx$}. Default files \file{Uvel.dat}, \file{Vvel.dat} and \file{UVinfo.dat} may be placed to be used for levels for which related (advection) files are missing.

\item[\file{CLminmax}, and/or \file{SNminmax}] can be placed in the \directory{divaparam} subdirectory. These files are used (if present) for $L$ and/or $\snr$ optimisation, in the case where the maximum and the minimum acceptable values for correlation length, and/or signal-to-noise parameter values for each level is to be specified (see Section~\ref{3Dpreproc}).


\item[\file{valatxy.coord.var.$1xxxx$} files:] two-column (at least) lists of locations where one wants to have the performed analysis values in ascii files as an output for the related variable and level. It is possible to provide files \file{valatxy.coord.$1xxxx$} for the corresponding levels only, independently of the variable and only \file{valatxy.coord} independent from variables and levels. The output will be always related to variables and levels.

\end{description}


\subsection{More \directory{DIVA3D/divastripped/input/} input subdirectories}
%--------------------------------------


\subsubsection{\directory{divaUVcons}}

This subdirectory is located in the \directory{divastripped/input} directory, and contains input files of advection constraint\index{Advection}.

It may contain the following files:

\vspace{0.5cm}
\centerline{
\begin{tabular}{|ccc|}
\hline
\file{UVinfo.var.$1xxxx$}&\file{UVinfo.$1xxxx$}&\file{UVinfo.dat}\\
\file{Uvel.var.$1xxxx$} &\file{Uvel.$1xxxx$} & \file{Uvel.dat} \\
\file{Vvel.var.$1xxxx$} &\file{Vvel.$1xxxx$} & \file{Vvel.dat} \\
\hline
\end{tabular}
}
\vspace{0.3cm}

\begin{description}

\item[\file{Uvel.var.$1xxxx$}, \file{Vvel.var.$1xxxx$} and \file{UVinfo.var.$1xxxx$}] named with regard to the variable name and the corresponding level depth number, and/or
 
\item[\file{Uvel.$1xxxx$}, \file{Vvel.$1xxxx$} and  \file{UVinfo.$1xxxx$}] numbered following the level to which they correspond and/or

\item[\file{Uvel.dat} and \file{Vvel.dat} and \file{UVinfo.dat}].

\end{description}


\subsubsection{\directory{divarefe}}

This subdirectory is located in the \directory{divastripped/input/} directory, and contains reference field files which can be used by \diva as background for the analyses. This files can be semi normed reference field files produced  previously by \diva.

It may contain the following files:\par

\vspace{0.5cm}
\centerline{
\begin{tabular}{|cc|}
\hline
\file{GridInfo.dat} & \file{var.1$xxxx$.ref} \\
\file{var.1$xxxx$.ascii.ref}&\file{var.1$xxxx$.datapoint.ref}\\
\hline
\end{tabular}
}
\vspace{0.3cm}

\begin{description}

\item[\file{var.$1xxxx$.ascii.ref}:] 2D gridded reference field files in ascii format named with regard to the corresponding variable name and depth level number, and/or 
\item[\file{var.$1xxxx$.ref}:] 2D gridded reference field files in GHER format (binary)  named with regard to the corresponding variable name and depth level number, and if available 
\item[\file{var.$1xxxx$.datapoint.ref}:] data file (three columns files) which contains the variable reference field value at data points.

\end{description}

\subsubsection{\directory{divamesh}}

This subdirectory is located in the \directory{divastripped/input} directory, and contains mesh files which can be used by \diva instead of generating a new ones. This files can be produced  previously by \diva in a preprocessing' step .

It may contain the following files:\par

\vspace{0.5cm}
\centerline{
\begin{tabular}{|cc|}
\hline
\file{meshtopo.1$xxxx$}&\file{mesh.dat.1$xxxx$}\\
\hline
\end{tabular}
}
\vspace{0.3cm}


\begin{description}
\item[\file{meshtopo.1$xxxx$} and related \file{mesh.dat.1$xxxx$}], named following the depth level number to which they correspond.

\end{description}


\section{Input info files: \texttt{contour.depth} \& \texttt{3Dinfo}}
%----------------

In order to be able to use the three dimensional features of \diva one has to provide two info-files in the \directory{DIVA3D/divastripped/input/} input directory:


\vspace{0.5cm}
\centerline{
\begin{tabular}{|cc|}
\hline
\file{contour.depth}&\file{3Dinfo}\\
\hline
\end{tabular}
}
\vspace{0.3cm}


\subsection{\file{contour.depth}}

\begin{description}

\item[\file{contour.depth}] contains a list of depth values (one value per line) of the considered levels. The first line corresponds to the deepest level and the last one to the top level. 

\item[\file{3Dinfo}] is the file where shell script reads the parameter values for the 3D execution: variable name, levels to be treated, flags values controlling the execution of tasks to be performed and, maximum and minimum acceptable values for correlation length ($L$) and signal-to-noise ($\snr$) parameters. If one desires to specify the maximum and the minimum values for $L$  and/or ($\snr$) parameter for each level, a file \texttt{CLminmax} and/or \texttt{SNminmax} must be placed in the \directory{divaparam} subdirectory. In this case the corresponding maximum and minimum values in the \file{3Dinfo} file are ignored.
\end{description}

\begin{center}
\begin{exfile}[H] %[htpb]
\begin{footnotesize}
\begin{verbatim}
2000
1500
1000
800
600
500
400
300
250
200
150
125
100
75
50
30
20
10
5
0
\end{verbatim}
\end{footnotesize}
\caption{\file{contour.depth}}
\label{contdepthfile}
\end{exfile}

\end{center}




\subsection{The \texttt{3Dinfo} file \label{sec:3Dinfo}}

The information file \file{3Dinfo} must be placed in the \directory{input} directory and must contain all the following information and option flag values:

\begin{itemize}
\item $var$ :  variable short name which names data files (\file{var.$1xxxx$})
\item $L_1$ :  Number of the first level to be treated. 
\item $L_2$ :  Number of the last level to be treated.
\item {\bf contour generation} : 
              \begin{itemize}
                \item[*] $=1$ if contour files are to be generated,
                \item[*] $=2$ if advection constraint (anisotropic correlation along topography) files are to be generated from \file{topo.grd},
                \item[*] $=3$ if contour files and advection constraint are to be generated.
              \end{itemize}
\item {\bf Cleaning data and Relative Length}: 
              \begin{itemize}
                \item[*] $=1$ if data files are to be cleaned,
                \item[*] $=2$ if relative length files are to be generated,
                \item[*] $=3$ if data files are to be cleaned and relative length files are to be generated.
                \item[*] $=4$ if outliers are to be cleaned from data files.
                \item[*] $=5$ if outliers are to be cleaned from data files and, relative length files to be generated.
              \end{itemize}


\item {\bf Parameter optimization}: Possible flag values are $0$, $1$, $2$, $3$, $-1$, $-2$, $-3$, $10$, $-10$, $30$ and $-30$:
              \begin{itemize}
                \item[*] $=1$ if correlation length parameters are to be estimated,
                \item[*] $=2$ if signal-to-noise ratio ($S/N$) parameters are to be estimated,
                \item[*] $=-1$ if correlation length parameters are to be estimated and vertically filtered,
                \item[*] $=-2$ if signal-to-noise ratio ($S/N$) parameters are to be estimated and vertically filtered,
                \item[*] $=3$ if both  correlation length and  signal-to-noise ratio parameters are to be estimated,
                \item[*] $=-3$ if both  correlation length and  signal-to-noise ratio parameters are to be estimated and vertically filtered,

                \item[*] $=10$ if correlation length parameters are to be estimated using data mean distance as a minimum,
                \item[*] $=-10$ if correlation length parameters are to be estimated using data mean distance as a minimum and vertically filtered,
                \item[*] $=30$ if both  correlation length and  signal-to-noise ratio parameters are to be estimated using data mean distance as a minimum (for $L$),
                \item[*] $=-30$ if both  correlation length and  signal-to-noise ratio parameters are to be estimated using data mean distance as a minimum (for $L$), and both parameters vertically filtered.
% and generated relative length fields (for $S/N$)
              \end{itemize}

\item {\bf Perform analysis}: Possible flag values are $0$, $1$ and $2$:
              \begin{itemize}
                \item[*] $=2$ if semi normed reference fields of the considered variable are to be performed for all the levels between $L_1$ and $L_2$.
                \item[*] $=1$ if analysis fields of the considered variable are to be performed for all the levels between $L_1$ and $L_2$.
              \end{itemize}
\item $MaxCL$ : maximum value for correlation length (ignored if a \file{CLminmax} file is provided in \directory{divaparam}).
\item $MinCL$ : minimum value for correlation length  (ignored if a \file{CLminmax} file is provided in \directory{divaparam}).
\item $MaxSN$ : maximum value for signal-to-noise ratio (ignored if a \file{SNminmax} file is provided in \directory{divaparam}).
\item $MinSN$ : minimum value for signal-to-noise ratio (ignored if a \file{SNminmax} file is provided in \directory{divaparam}).
\item $Gnplt$ : $=1$ if Gnuplot plot files are to be generated.
\item $MinGP$ : minimum value of the variable for Gnuplot plots.
\item $MaxGP$ : maximum value of the variable for Gnuplot plots.
\item \it{'Title String'} : Title string for 3D-NetCDF file.
\item \it{'Variable name string'} : Variable long name string.
\item \it{'Units string'} : Variable units string
\end{itemize}


\begin{exfile}[H] %[htpb]
\begin{footnotesize}
\begin{verbatim}
# Variable (var) to be analysed (located in data/var.1xxxx):
psal
# Number of the first level to be processed (bottom?):
1
# Number of the last level to be processed (surface?):
25
# Contours generation (0, 1, 2, 3):
3
# Data cleaning (0: if no, 1: data cleaning only, 2: RL files, 3: 1 and 2):
3
# Parameters optimisation (0, 1, 2, -1, -2, 3, -3, and +or- 10,20 and 30):
-30
# Perform analyses (0 if no, 1: analyses, 2: references):
1
# Minimum value for correlation length:
0.5
# Maximum value for correlation length:
4.
# Minimum value for S/N:
0.1
# Maximum value for S/N:
50.
# Gnuplot plots generation (1 if yes, 0 if no):
0
# Variable minimum value for gnuplot plots:
6
# Variable maximum value for gnuplot plots:
40
# Title string for salinity 3D NetCDF file:
'Diva 3D analysis of the variable'
# Variable long name string:
'Potential salinity'
# Variable units string:
'psu'
\end{verbatim}
\end{footnotesize}
\caption{\file{3Dinfo} file}
\label{3Dinfotfile}
\end{exfile}

\section{3D analyses: inputs preparation \label{3Dpreproc}}
%---------------------------------------------------

The working directory for running a 3D \diva analysis is \directory{DIVA3D/divastripped/} directory. All \diva 3D runs can be done by simply running the shell script \command{diva3Ddress}. The \command{diva3Ddress} performs the actions prescribed in the info file \file{3Dinfo}.


\subsection{Coast contour files generation \label{contgeneration}}

To generate coast contour files for all the levels of which depth is present in the \file{contour.depth} file in the \directory{divastripped/input}, one has to choose the flag number $1$ or $3$ in the \file{3Dinfo} file and provide as input in \directory{divastripped/input} a bathymetry file of the area of interest. the input bathymetry file may be an ascii \file{topo.dat} or a GHER format binary file \file{topo.grd} and the related \file{TopoInfo.dat} as described in Section~\ref{sec:contourtopo}. A \file{param.par} file is also needed, and can be placed in the \directory{divastripped/input} input directory.

The resulting coast contour files (\file{coast.cont.$1xxxx$}) are placed in the subdirectory \linebreak \directory{input/divaparam/}. If the chosen flag number for contour generation in the \file{3Dinfo} file is $3$, advection constraint files (anisotropic correlations along topography) are generated as well, and placed in \file{input/divaUVcons} subdirectory.



\vspace{0.5cm}
\centerline{
\begin{tabular}{|c|l|}
\hline
{\bf Input} & {\bf Output} \\
\hline
\file{param.par}, \file{contour.depth} & \file{coast.cont.$1xxxx$} in \directory{divaparam} \\
\file{topo.dat} or &  \file{Uvel.$1xxxx$} and \file{Vvel.$1xxxx$} in \directory{divaUVcons} \\
\file{topo.grd} and  \file{TopoInfo.dat}   & \\
\hline
\end{tabular}
}

\subsection{Data sets cleaning}

All data sets provided in \directory{DIVA3D/divastripped/input/divadata/} can be cleaned from data points located outside the mesh and from suspected outliers. Choose a flag number corresponding to the desired action for data sets cleaning in the \file{3Dinfo} file. A \file{param.par} file is also needed, and can be placed in the \directory{divastripped/input/} input directory.

At this stage, field of scaling factors to the correlation length can be generated on the basis of data distribution, and for the levels corresponding to each data set (see Section~\ref{sec:3Dinfo}).


\vspace{0.5cm}
\centerline{
\begin{tabular}{|c|l|}
\hline
{\bf Input} & {\bf Output} in \directory{input/divadata/} \\
\hline
\file{param.par} &  \file{var.$1xxxx$.notcln}: original data set files \\
 \& &  \file{var.$1xxxx$.clean}: data set files cleaned from data out of the mesh \\
  \file{var.$1xxxx$} &  \file{var.$1xxxx$.withoutliers}: data set files cleaned with outliers \\
  &  \file{var.$1xxxx$}: The cleaned data set files \\
\hline
\end{tabular}
}



\subsection{Parameters optimisation}

The estimation of analysis parameters (see Chapter~\ref{chap:analysisparameters}) can be done for all levels using \command{diva3Ddress}. It is possible to optimise one or more parameter for a range of levels with different options (see Section~\ref{sec:3Dinfo}). The parameters which can be optimised are correlation length $L$, signal-to-noise ratio $S/N$ and the error variance background $VARBAK$. The parameters optimisation can be done within a range of bounds (a maximum and a minimum). The bounds can be prescribed for all levels in the \file{3Dfile} (see Section~\ref{sec:3Dinfo}) or varying with levels by giving the list of bound in files \file{CLminmax} and/or \file{SNminmax}.

To perform parameters optimisation, one can place a default \file{param.par} with an approximated values for correlation length ($L$), signal-to-noise ratio ($snr$) and variance ($VARBAK$) parameter values, in \directory{input/divaparam/} (or \directory{input}) directory). If parameter bounds are desired for each considered level, one can place a bound file corresponding to the parameter(s) to be optimised (\file{CLminmax} and/or \file{SNminmax}) in \directory{input/divaparam/}, or prescribe a general one in \file{3Dinfo} file. Choose the appropriate flag value in the \file{3Dinfo} file (see Section~\ref{sec:3Dinfo}). The 3D analysis parameter optimisation output is a set of \file{param.par} indexed following the variable name and the corresponding level, and summary files of estimated parameters before and/or after vertical filtering.

\vspace{0.5cm}
\centerline{
\begin{tabular}{|c|c|}
\hline
{\bf Input} & {\bf Output} in \directory{input/divaparam/} \\
\hline
\file{param.par} &  \file{param.par.var.$1xxxx$} \\
  in \directory{divaparam} &  with optimised $L$, $snr$, and $VARBAK$ \\
   or &  \file{var.CL.dat.filtered},  \file{var.CL.dat.notfiltered} \\
  in \directory{input/divaparam/} &  \file{var.SN.dat.filtered},  \file{var.SN.dat.notfiltered} \\
  &  \file{var.VAR.dat.filtered},  \file{var.VAR.dat.notfiltered} \\
\hline
\end{tabular}
}

\section{Performing 3D analyses: \texttt{diva3Ddress}}

\subsection{A simple analysis: input files}

\subsubsection{Input files in \directory{divastripped/input/}}

The minimum input files for performing a \diva 3D analysis consists of:

\begin{itemize}
\item \file{3Dinfo} file (see \ref{3Dinfotfile}),
\item \file{contour.depth} file (see \ref{contdepthfile}),
\item \file{coast.cont.$1xxxx$} files for all considered levels in \directory{divaparam} subdirectory (see \ref{contgeneration}),
\item \file{param.par} files:
\begin{itemize}
\item[*] \file{param.par.var.$1xxxx$} for all considered levels and prepared for the considered variable put in \directory{divaparam} subdirectory, or
\item[*] \file{param.par.$1xxxx$} for all considered levels \directory{divaparam} subdirectory, or
\item[*] one \file{param.par} file put in  \directory{divastripped/input/} directory or in\\ 
\directory{divastripped/input/divaparam/} subdirectory.
\end{itemize}
\item data sets for all considered levels \file{var.$1xxxx$} files in \directory{divadata} subdirectory.
\end{itemize}


\btips
If for a level (or all levels) \file{param.par.var.$1xxxx$} is not present, one default \file{param.par} file must be placed in the \file{divaparam} subdirectory or in the input directory.
\etips

\subsubsection{ Using relative length files:}

If more than one relative length files are available, they must be  named and numbered following the variable and level to which they correspond as \file{RL.var.$1xxxx$}, and must be provided in the \directory{input/divaparam/} subdirectory. One default file \file{RL.dat} may be placed in \directory{input/divaparam} subdirectory to be used for the levels for which relative length files are missing. One \file{RLinfo.dat} ascii file (grid info file) must be placed with the relative length files (binary GHER format)

If only one \file{RL.dat} file of relative length is used, it must be placed in the \directory{divaparam} subdirectory or in the \file{input} directory.

\begin{center}
\fbox{
\begin{minipage}{0.9\textwidth}
\vspace{.25cm}
\textbf{Convention:} When a \underline{\file{RLinfo.dat}} file is present in the \directory{divaparam} subdirectory or in the \directory{input} directory, \diva will perform 3D analysis using relative length files.\\
\vspace{.25cm}
\end{minipage}
}
\end{center}


\subsubsection{Using advection constraint\label{advconstuse}}

To perform 3D analysis with avection constraint\index{Advection}, the files \file{UVinfo.var.$1xxxx$},\linebreak \file{Uvel.var.$1xxxx$}, \file{Vvel.var.$1xxxx$}, must be then placed in \directory{input/divaUVcons/} subdirectory. The advection constraint is activated when a \file{constraint.dat} file is present in the \directory{input} directory (see Section~\ref{ex:constraint.dat}). If one wants to use different advection parameters $\theta$ and $\mathcal{A}$ (see Section~\ref{sec:advection}) a two column \file{3Dconstraint} file must be placed in \directory{input/divaparam} subdirectory where each line contains the advection parameters for the corresponding level number.

If \file{UVinfo} files are identical for all the levels, only one file \file{UVinfo.dat} may be placed in the \directory{input} directory or in the \directory{input/divaUVcons} subdirectory.

If for some levels, the pair of files \file{Uvel.var.$1xxxx$}, \file{Vvel.var.$1xxxx$} (or \file{Uvel.$1xxxx$}, \file{Vvel.$1xxxx$}) is not available, A default \file{Uvel.dat} and \file{Vvel.dat} files must be placed in the \directory{input/divaUVcons/} subdirectory as well as a \file{UVinfo.dat} if using different \file{UVinfo} files.

If for all levels, the same advection files are used, only \file{Uvel.dat}, \file{Vvel.dat} and \file{UVinfo.dat} may be placed in the \directory{input/divaUVcons/} subdirectory or simply in the \directory{input} directory.


\begin{center}
\fbox{
\begin{minipage}{0.9\textwidth}
\vspace{.25cm}
\textbf{Convention:} The advection constraint is activated when a \underline{\file{3Dconstraint}} file is present in the \directory{divaparam} subdirectory or a \underline{\file{constraint.dat}} is present in the \directory{input} directory.
\vspace{.25cm}
\end{minipage}
}
\end{center}


\subsubsection{Using reference fields\label{divarefeuse}}


If reference fields are present in the \directory{input/divarefe} subdirectory, they will be used automatically by \diva to perform 3D analysis using the reference field files as a background.

To use a variable reference field as background for given level number, the \file{GridInfo.dat} and at least one of the three types of reference files \file{var.$1xxxx$.ascii.ref} (2D ascii file),\file{var.$1xxxx$.datapoint.ref} reference at data points or \file{var.$1xxxx$.ref} binary 2D GHER format must be present in the \directory{divarefe} subdirectory.

\begin{center}
\fbox{
\begin{minipage}{0.9\textwidth}
\vspace{.25cm}
\textbf{Convention:} The use of reference fields for a given level is activated when the corresponding reference field files are present in the \directory{divarefe} subdirectory.
\vspace{.25cm}
\end{minipage}
}
\end{center}



\subsubsection{Using detrending}


To perform \diva 3D analysis with detrending\index{Detrending} of data, a \file{detrendinfo} file must be provided in the directory \directory{input}. The \file{detrendinfo} has two columns and one line: where the group number of detrending is prescribed in the first column, and the iterations number in the second (see Section~\ref{sec:detrending}). In this case all data set files should have the right number of columns starting from the fifth and where classes are numbered.


\begin{center}
\fbox{
\begin{minipage}{0.9\textwidth}
\vspace{.25cm}
\textbf{Convention:} \diva 3D analysis with data detrending is activated when \file{detrendinfo} file is present in the \directory{input} directory.
\vspace{.25cm}
\end{minipage}
}
\end{center}



\subsubsection{Running \command{diva3Ddress}}

To run \diva to perform a 3D analysis, one has simply to run the shell script file \command{diva3Ddress} in \directory{divastripped}. \diva 3D analysis outputs are normal analysis of a variable or reference fields, depending on the chosen flag number for analysis in the \file{3Dinfo} (see Section~\ref{sec:3Dinfo}).


\subsection{\diva 3D analysis outputs}

The outputs are placed in \directory{output/3Danalysis/} and consist of:

\begin{description}

\item[The 3D analysis files:] in NetCDF\index{NetCDF} and GHER binary format.

\begin{figure}[H]
\centering
\parbox{\textwidth}{
%\begin{footnotesize}
\begin{tabular}{|ll|} \hline
                       						  & \file{var.$1xxxx$.$1yyyy$.fieldgher.anl} \\
\file{var.$1xxxx$.$1yyyy$.anl.nc}             & \file{var.$1xxxx$.$1yyyy$.fieldgher.ref} \\
\file{var.$1xxxx$.$1yyyy$.errorfieldgher.anl} & \file{var.$1xxxx$.$1yyyy$.ref.nc}  \\ 
\hline
\end{tabular}
%\end{footnotesize}
}
\caption{Content of \directory{output/3Danalysis/}}
\end{figure}

{\bf The 3D variable analysis NetCDF file contains the diva analysis of the variable and a set of variable related information fields: relative error and error standard deviation fields, variable masked (using two relative error thresholds) fields, deepest values of the variable field and the related masked fields. It contains also fields of information about data distribution and outliers as well as fields of correlation length and signal-to-noise ratio parameters.} %(see \ref{3Dncfile})


\item[A subdirectory \directory{Fields}] containing all the \diva 2D output files for all levels:

\begin{figure}[H]
\centering
\parbox{\textwidth}{
\begin{footnotesize}
\begin{tabular}{|lll|} \hline

\file{GridInfo.dat}                       & \file{var.$1xxxx$.ref }             & \file{var.$1xxxx$.error}      \\
\file{var.$1xxxx$.anl}              & \file{var.$1xxxx$.ascii.ref }       & \file{var.$1xxxx$.errorascii} \\
\file{var.$1xxxx$.anl.nc}           & \file{var.$1xxxx$.datapoint.ref}    & \file{var.$1xxxx$.valatxyasc.ref}\\
\file{var.$1xxxx$.ascii.anl}        & \file{var.$1xxxx$.ref.nc}           & \file{valatxy.var.$1xxxx$}\\
\file{var.$1xxxx$.outliersbis}      & \file{var.$1xxxx$.outliersbis.norm} & \\
\hline
\end{tabular}
\end{footnotesize}
}
\caption{Content of \directory{output/3Danalysis/Fields/}}
\end{figure}


\item[A subdirectory \directory{datadetrend}:] it contains trend data set files for all levels \linebreak \file{trends.$i$.dat.var.$1xxxx$} ($i$ is the group number).


\item[A subdirectory \directory{Meshes}:] it contains the mesh files, so that they can be re-used for other applications.

\item[Log files] Two log files are generated:
\begin{itemize}
\item  \file{diva.log}: Log file of fortran binaries run in \directory{./output/}
\item  \file{var.diva3D.log}: Log file of shell scripts execution in \directory{output/3Danalysis}.
\end{itemize}

\end{description}
